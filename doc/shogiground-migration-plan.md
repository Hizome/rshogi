# shogiground 对照结论与迁移计划

本文汇总我们对 `shogiground`/`lishogi` 的关键讨论，并给出可直接执行的迁移步骤，目标是把当前 `rshogi` UI 与交互逐步对齐到成熟方案。

## 1. 已确认的实现结论

## 1.1 右键与画箭头

- 右键（或 `Shift`）不是普通拖子，而是进入 `draw` 流程。
- 棋盘与据台都支持该逻辑：棋盘用 `startDragOrDraw`，据台用 `startDragFromHand`。
- 右键拖拽时会持续更新目标点，松开后提交 shape（箭头/标记），再次画同一条可取消。
- 这套逻辑本质是一个独立“绘制状态机”，与走子/打入状态机并行。

## 1.2 据台（hand）渲染

- 据台结构与样式分离：
  - 结构层：生成固定角色槽位（如 pawn/lance/...）。
  - 状态层：更新数量、选中态、预选态、最后落点态。
- 数量徽标不是额外节点，而是通过样式伪元素显示（`data-nb`）。
- 结论：你当前 Rust 代码也应采用“槽位固定 + 状态刷新”模式，而不是每次重建 UI。

## 1.3 打入（drop）与拖拽

- 拖拽来源统一抽象为两类：`from_board` / `from_hand`。
- 释放时统一做合法性判断：
  - 合法 -> 提交 `move` 或 `drop`
  - 非法 -> 回原位（棋盘与据台一致）
- 正确行为包括：
  - 拖拽中原位棋子隐藏，避免“看起来两个棋子”。
  - 拖拽中显示合法目标高亮，与点击选子一致。

## 1.4 升变 UI

- 升变是覆盖层（overlay）+ 就地选择框，不破坏主棋盘结构。
- 推荐实现为独立组件状态：
  - `promotion_pending: Option<{ from, to, piece }>`
  - 用户选择后再真正提交走子。
- 先统一英文文案，避免字体缺字问题。

## 1.5 棋盘星位点与据台“实体感”

- 星位点不是逻辑层生成，也不是必须由贴图自带；在 `shogiground/lishogi` 中主要由 CSS 伪元素完成（按特定格子索引打点）。
- 据台“正方形实体感”主要来自样式：
  - 木纹背景（与棋盘同材质）
  - 边框
  - 固定或比例化布局容器
- 本项目 UI 决策：据台采用正方形渲染，不使用长条据台。
- 结论：在 Rust/GPUI 中应把“棋盘线/星位点/纹理/边框”拆成独立绘制层，便于主题化。

## 2. 面向 rshogi 的迁移原则

1. 先对齐交互模型，再做视觉微调。
2. 状态机先于动画：保证正确性后再补过渡效果。
3. 棋盘/据台/覆盖层分层渲染，避免相互耦合。
4. 所有用户动作统一走 `Action -> update()`，UI 不直接改核心状态。

## 3. 迁移步骤（执行版）

## P1.5：UI 结构与绘制层重排（优先）

目标：为后续交互对齐打基础。

任务：

1. 棋盘分层
- `board_texture`（底图）
- `grid_lines`（网格）
- `star_points`（星位点）
- `piece_layer`（棋子）
- `overlay_layer`（高亮/箭头/升变）

2. 据台分层
- `hand_container`（边框/背景）
- `hand_slots`（固定槽位）
- `hand_badges`（数量）
- `hand_state_highlight`（selected/preselected/last-dest）

3. 布局
- 左侧：对手据台（纵向）
- 中间：棋盘
- 右侧：己方据台（纵向）
- 两侧据台均为正方形容器
- 对手据台顶部与棋盘顶部对齐
- 己方据台底部与棋盘底部对齐
- 整体靠左对齐（按你现有需求）

完成标准：

- 不改行为，仅改结构，视觉与当前一致或更稳定。

## P2：拖拽统一状态机（走子 + 打入）

目标：统一点击与拖拽的行为一致性。

任务：

1. 新增 `DragState`
- `source: Board(key) | Hand(piece)`
- `piece`
- `origin_pos`
- `current_pos`
- `started`

2. 拖拽期间行为
- 源位置棋子隐藏
- 计算并展示合法目标高亮
- 棋盘外显示非法态（可选）

3. 释放行为
- 合法提交 `Action::Move` / `Action::Drop`
- 非法回弹并清理拖拽态

完成标准：

- 棋盘拖子与据台拖入行为完全一致，且无“双影棋子”问题。

## P3：升变流程标准化

目标：升变变成可复用流程，不散落在事件代码里。

任务：

1. 在 `update` 层判断是否需要升变选择。
2. 进入 `promotion_pending` 后冻结其他落子动作。
3. 弹窗选择 `Promote / Keep`（英文）。
4. 选择后提交最终 move，清理 pending。

完成标准：

- 点击与拖拽都走同一升变分支，无分叉 bug。

## P4：右键标注系统（可并行）

目标：复刻 lishogi 常用教学/分析标注能力。

任务：

1. `AnnotationState`
- `arrows: Vec<Arrow>`
- `marks: Vec<Mark>`
- `current_drawing: Option<...>`

2. 事件
- 右键/Shift 开始绘制
- 移动实时预览
- 松开提交
- 同图元再次绘制即删除（toggle）

3. 渲染
- 棋盘 SVG/矢量层绘制箭头
- 方格标记（圈点）与颜色画笔预留

完成标准：

- 不影响主走子逻辑，可独立启停。

## P5：主题化与资源替换

目标：将“硬编码样式”替换为可配置主题。

任务：

1. 提取样式常量（线宽、星位点尺寸、据台背景、边框色）。
2. 支持至少两套棋盘贴图。
3. 支持按棋盘尺寸动态调星位点大小（为 mini 视图预留）。

完成标准：

- 替换主题不改业务代码。

## 4. 推荐代码拆分（对齐当前项目）

```text
src/
  app/
    state.rs
    action.rs
    update.rs
  ui/
    board.rs          # 棋盘分层绘制
    hand.rs           # 据台渲染与交互
    overlay.rs        # 高亮/箭头/标记/升变
    drag.rs           # 拖拽状态与事件路由
    promotion.rs      # 升变弹窗
    layout.rs         # 左-中-右布局
    assets.rs         # 棋盘贴图/棋子资源映射
```

## 5. 验收清单（按你当前目标）

1. 走子拖拽：原位隐藏、合法高亮、非法回位。
2. 打入拖拽：据台拖出、合法高亮、非法回位。
3. 升变：弹窗可见、英文文案、路径统一。
4. 据台：左右纵向、正方形容器；左侧对齐棋盘上沿，右侧对齐棋盘下沿；标题在框内上方且不额外拉宽。
5. 棋盘：网格清晰、星位点正确、贴图与据台风格统一。

---

如需，我下一步可以把这个文档的 P1.5/P2 直接拆成可打勾的工程任务（按文件粒度）并同步回 `doc/implementation-roadmap.md`。
